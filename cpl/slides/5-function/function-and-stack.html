<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C语言函数调用栈可视化</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #4CAF50, #8BC34A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #ccc;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .code-section, .stack-section, .memory-section {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #4CAF50;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }
        
        .code-editor {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            color: #d4d4d4;
            line-height: 1.5;
            overflow-x: auto;
            margin-bottom: 15px;
            border: 1px solid #444;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .code-line {
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
            white-space: pre;
        }
        
        .code-line.active {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }
        
        .stack-container {
            height: 400px;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 5px;
            padding: 15px;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            overflow-y: auto;
        }
        
        .stack-frame {
            width: 95%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, opacity 0.3s;
            border: 2px solid transparent;
        }
        
        .stack-frame.main {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .stack-frame.factorial {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .stack-frame.sum {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .stack-frame.active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid #f1c40f;
        }
        
        .frame-details {
            font-size: 0.8rem;
            margin-top: 8px;
            font-weight: normal;
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 4px;
        }
        
        .memory-container {
            height: 400px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 15px;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            overflow-y: auto;
        }
        
        .memory-segment {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .segment-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #f1c40f;
        }
        
        .memory-cell {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }
        
        .memory-address {
            color: #3498db;
        }
        
        .memory-value {
            color: #2ecc71;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
            color: #ccc;
        }
        
        .explanation {
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .explanation h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .explanation p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .concepts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .concept-card {
            background: rgba(40, 40, 50, 0.8);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .concept-card h4 {
            color: #f1c40f;
            margin-bottom: 8px;
        }
        
        .concept-card p {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .resources {
            margin-top: 30px;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .resources h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }
        
        .resources ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .resources li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .resources li:before {
            content: "•";
            color: #4CAF50;
            position: absolute;
            left: 0;
        }
        
        .resources a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .resources a:hover {
            color: #4CAF50;
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .code-section, .stack-section, .memory-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>C语言函数调用栈可视化</h1>
            <p class="subtitle">深入理解函数调用、栈帧创建和内存管理</p>
        </header>
        
        <div class="content">
            <div class="code-section">
                <h2 class="section-title">C语言代码</h2>
                <div class="code-editor">
                    <div class="code-line">#include &lt;stdio.h&gt;</div>
                    <div class="code-line"></div>
                    <div class="code-line">int factorial(int n) {</div>
                    <div class="code-line">    if (n <= 1) {</div>
                    <div class="code-line">        return 1;</div>
                    <div class="code-line">    }</div>
                    <div class="code-line">    return n * factorial(n - 1);</div>
                    <div class="code-line">}</div>
                    <div class="code-line"></div>
                    <div class="code-line">int sum(int a, int b) {</div>
                    <div class="code-line">    int result = a + b;</div>
                    <div class="code-line">    return result;</div>
                    <div class="code-line">}</div>
                    <div class="code-line"></div>
                    <div class="code-line">int main() {</div>
                    <div class="code-line">    int x = 5;</div>
                    <div class="code-line">    int y = factorial(3);</div>
                    <div class="code-line">    int z = sum(x, y);</div>
                    <div class="code-line">    printf("结果: %d\n", z);</div>
                    <div class="code-line">    return 0;</div>
                    <div class="code-line">}</div>
                </div>
                <p>这是一个包含多个函数调用的C程序示例。观察函数调用时栈帧的创建和销毁过程。</p>
            </div>
            
            <div class="stack-section">
                <h2 class="section-title">函数调用栈</h2>
                <div class="stack-container" id="stackContainer">
                    <!-- 栈帧将通过JavaScript动态添加 -->
                </div>
            </div>
            
            <div class="memory-section">
                <h2 class="section-title">内存布局</h2>
                <div class="memory-container" id="memoryContainer">
                    <div class="memory-segment" style="background: rgba(231, 76, 60, 0.2);">
                        <div class="segment-title">栈 (Stack)</div>
                        <div class="memory-cell">
                            <span class="memory-address">0x7ffd42a1b5a0</span>
                            <span class="memory-value">main() 返回地址</span>
                        </div>
                        <div class="memory-cell">
                            <span class="memory-address">0x7ffd42a1b598</span>
                            <span class="memory-value">main() 栈帧基址</span>
                        </div>
                    </div>
                    
                    <div class="memory-segment" style="background: rgba(52, 152, 219, 0.2);">
                        <div class="segment-title">堆 (Heap)</div>
                        <div class="memory-cell">
                            <span class="memory-address">0x55a1b4e2b6b0</span>
                            <span class="memory-value">动态分配内存</span>
                        </div>
                    </div>
                    
                    <div class="memory-segment" style="background: rgba(46, 204, 113, 0.2);">
                        <div class="segment-title">数据段 (Data Segment)</div>
                        <div class="memory-cell">
                            <span class="memory-address">0x55a1b4e2a010</span>
                            <span class="memory-value">全局变量</span>
                        </div>
                    </div>
                    
                    <div class="memory-segment" style="background: rgba(155, 89, 182, 0.2);">
                        <div class="segment-title">代码段 (Text Segment)</div>
                        <div class="memory-cell">
                            <span class="memory-address">0x55a1b4e2a000</span>
                            <span class="memory-value">程序指令</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="prevStep">上一步</button>
            <button id="nextStep">下一步</button>
            <button id="autoRun">自动运行</button>
            <button id="reset">重置</button>
            <div class="speed-control">
                <label for="speed">速度:</label>
                <input type="range" id="speed" min="1" max="10" value="5">
            </div>
        </div>
        
        <div class="explanation">
            <h3>函数调用栈详解</h3>
            <p id="stepDescription">程序开始执行，main()函数被调用，创建第一个栈帧。</p>
            
            <div class="concepts">
                <div class="concept-card">
                    <h4>栈帧 (Stack Frame)</h4>
                    <p>每个函数调用时在栈上分配的内存区域，包含返回地址、参数、局部变量等。</p>
                </div>
                <div class="concept-card">
                    <h4>基址指针 (BP)</h4>
                    <p>指向当前栈帧开始位置的指针，用于访问参数和局部变量。</p>
                </div>
                <div class="concept-card">
                    <h4>栈指针 (SP)</h4>
                    <p>指向栈顶位置的指针，随着数据入栈和出栈而移动。</p>
                </div>
                <div class="concept-card">
                    <h4>调用约定</h4>
                    <p>规定参数传递、寄存器使用和栈清理的规则，如cdecl、stdcall等。</p>
                </div>
            </div>
        </div>
        
        <div class="resources">
            <h3>C语言栈相关学习资源</h3>
            <ul>
                <li><a href="https://www.geeksforgeeks.org/memory-layout-of-c-program/" target="_blank">C程序内存布局 - GeeksforGeeks</a></li>
                <li><a href="https://en.wikipedia.org/wiki/Call_stack" target="_blank">调用栈原理 - Wikipedia</a></li>
                <li><a href="https://www.learn-c.org/" target="_blank">C语言交互式教程 - Learn-C.org</a></li>
                <li><a href="https://godbolt.org/" target="_blank">编译器资源管理器 - Godbolt</a></li>
            </ul>
        </div>
    </div>

    <script>
        // 初始化状态
        let currentStep = 0;
        const totalSteps = 16;
        const stackContainer = document.getElementById('stackContainer');
        const codeLines = document.querySelectorAll('.code-line');
        const stepDescription = document.getElementById('stepDescription');
        const prevButton = document.getElementById('prevStep');
        const nextButton = document.getElementById('nextStep');
        const autoRunButton = document.getElementById('autoRun');
        const resetButton = document.getElementById('reset');
        const speedControl = document.getElementById('speed');
        
        let autoRunInterval = null;
        let isAutoRunning = false;
        
        // 步骤描述
        const stepDescriptions = [
            "程序开始执行，main()函数被调用，创建第一个栈帧",
            "main()函数开始执行，初始化局部变量 x = 5",
            "准备调用 factorial(3) 函数，参数压栈",
            "factorial(3) 函数被调用，创建新的栈帧",
            "factorial(3) 检查 n=3 是否小于等于1",
            "n=3 大于1，准备计算 3 * factorial(2)，递归调用",
            "factorial(2) 函数被调用，创建新的栈帧",
            "factorial(2) 检查 n=2 是否小于等于1",
            "n=2 大于1，准备计算 2 * factorial(1)，递归调用",
            "factorial(1) 函数被调用，创建新的栈帧",
            "factorial(1) 检查 n=1 是否小于等于1，条件满足",
            "factorial(1) 返回 1，栈帧被销毁",
            "factorial(2) 收到返回值，计算 2*1=2，返回结果，栈帧销毁",
            "factorial(3) 收到返回值，计算 3*2=6，返回结果，栈帧销毁",
            "main() 收到 factorial(3) 返回值，y=6，调用 sum(5, 6)",
            "sum(5, 6) 被调用，计算 5+6=11，返回结果，程序输出"
        ];
        
        // 初始化栈
        function initStack() {
            stackContainer.innerHTML = '';
            currentStep = 0;
            updateButtons();
            updateCodeHighlight();
            updateStepDescription();
            clearAutoRun();
        }
        
        // 更新按钮状态
        function updateButtons() {
            prevButton.disabled = currentStep === 0;
            nextButton.disabled = currentStep === totalSteps - 1;
            autoRunButton.textContent = isAutoRunning ? '暂停' : '自动运行';
        }
        
        // 更新代码高亮
        function updateCodeHighlight() {
            codeLines.forEach((line, index) => {
                line.classList.remove('active');
            });
            
            // 根据当前步骤高亮相应的代码行
            if (currentStep === 0) {
                codeLines[14].classList.add('active'); // main函数开始
            } else if (currentStep === 1) {
                codeLines[15].classList.add('active'); // 初始化x=5
            } else if (currentStep === 2) {
                codeLines[16].classList.add('active'); // 调用factorial(3)
            } else if (currentStep === 3) {
                codeLines[2].classList.add('active'); // factorial函数开始
            } else if (currentStep === 4) {
                codeLines[3].classList.add('active'); // 检查n<=1
            } else if (currentStep === 5) {
                codeLines[6].classList.add('active'); // 递归调用factorial(2)
            } else if (currentStep === 6) {
                codeLines[2].classList.add('active'); // factorial函数开始
            } else if (currentStep === 7) {
                codeLines[3].classList.add('active'); // 检查n<=1
            } else if (currentStep === 8) {
                codeLines[6].classList.add('active'); // 递归调用factorial(1)
            } else if (currentStep === 9) {
                codeLines[2].classList.add('active'); // factorial函数开始
            } else if (currentStep === 10) {
                codeLines[3].classList.add('active'); // 检查n<=1
            } else if (currentStep === 11) {
                codeLines[4].classList.add('active'); // 返回1
            } else if (currentStep === 12) {
                codeLines[6].classList.add('active'); // 返回2*1
            } else if (currentStep === 13) {
                codeLines[6].classList.add('active'); // 返回3*2
            } else if (currentStep === 14) {
                codeLines[17].classList.add('active'); // 调用sum函数
            } else if (currentStep === 15) {
                codeLines[18].classList.add('active'); // 输出结果
            }
        }
        
        // 更新步骤描述
        function updateStepDescription() {
            stepDescription.textContent = stepDescriptions[currentStep];
        }
        
        // 更新栈可视化
        function updateStackVisualization() {
            stackContainer.innerHTML = '';
            
            // 根据当前步骤添加栈帧
            if (currentStep >= 1) {
                addStackFrame('main()', 'main', currentStep >= 1 && currentStep <= 15, 
                    '局部变量: x=5, y, z\n返回地址: 0x5555555551a9');
            }
            
            if (currentStep >= 3 && currentStep <= 13) {
                addStackFrame('factorial(3)', 'factorial', currentStep >= 3 && currentStep <= 13, 
                    '参数: n=3\n返回地址: 0x555555555189');
            }
            
            if (currentStep >= 6 && currentStep <= 12) {
                addStackFrame('factorial(2)', 'factorial', currentStep >= 6 && currentStep <= 12, 
                    '参数: n=2\n返回地址: 0x555555555189');
            }
            
            if (currentStep >= 9 && currentStep <= 11) {
                addStackFrame('factorial(1)', 'factorial', currentStep >= 9 && currentStep <= 11, 
                    '参数: n=1\n返回地址: 0x555555555189');
            }
            
            if (currentStep >= 14 && currentStep <= 15) {
                addStackFrame('sum(5, 6)', 'sum', currentStep >= 14 && currentStep <= 15, 
                    '参数: a=5, b=6\n局部变量: result=11\n返回地址: 0x5555555551b4');
            }
        }
        
        // 添加栈帧
        function addStackFrame(name, type, isActive, details) {
            const frame = document.createElement('div');
            frame.className = `stack-frame ${type} ${isActive ? 'active' : ''}`;
            frame.innerHTML = `
                <div>${name}</div>
                <div class="frame-details">${details}</div>
            `;
            stackContainer.appendChild(frame);
        }
        
        // 下一步
        function nextStep() {
            if (currentStep < totalSteps - 1) {
                currentStep++;
                updateStackVisualization();
                updateCodeHighlight();
                updateButtons();
                updateStepDescription();
            }
        }
        
        // 上一步
        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                updateStackVisualization();
                updateCodeHighlight();
                updateButtons();
                updateStepDescription();
            }
        }
        
        // 自动运行
        function toggleAutoRun() {
            if (isAutoRunning) {
                clearAutoRun();
            } else {
                const speed = 1100 - (speedControl.value * 100);
                autoRunInterval = setInterval(() => {
                    if (currentStep < totalSteps - 1) {
                        nextStep();
                    } else {
                        clearAutoRun();
                    }
                }, speed);
                isAutoRunning = true;
                updateButtons();
            }
        }
        
        // 清除自动运行
        function clearAutoRun() {
            if (autoRunInterval) {
                clearInterval(autoRunInterval);
                autoRunInterval = null;
            }
            isAutoRunning = false;
            updateButtons();
        }
        
        // 事件监听
        nextButton.addEventListener('click', nextStep);
        prevButton.addEventListener('click', prevStep);
        autoRunButton.addEventListener('click', toggleAutoRun);
        resetButton.addEventListener('click', initStack);
        speedControl.addEventListener('input', function() {
            if (isAutoRunning) {
                clearAutoRun();
                toggleAutoRun();
            }
        });
        
        // 初始化
        initStack();
        updateStackVisualization();
    </script>
</body>
</html>